<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Cloudbeds ID Scanner</title>
		<link rel="stylesheet" href="popup.css" />
	</head>
	<body>
		<div class="container">
			<!-- Header -->
			<div class="header">
				<div class="logo">
					<span class="logo-text">Cloudbeds Companion <a href="https://github.com/domindez" target="_blank" rel="noopener" class="owner-tag">by Domindez</a></span>
				</div>
			</div>

			<!-- Tabs -->
			<div class="tabs">
				<button class="tab active" data-tab="scan">Escanear</button>
				<button class="tab" data-tab="cruces">Cruces</button>
				<button class="tab" data-tab="settings">Ajustes</button>
			</div>

			<!-- Tab Content: Escanear -->
			<div id="tab-scan" class="tab-content active">
				<!-- Botones principales -->
				<div class="main-buttons">
					<button id="loadDniBtn" class="btn btn-main btn-dni" title="Cargar 2 Ãºltimos escaneos para DNI o NIE espaÃ±ol">
						<span class="btn-icon-large">ğŸªª</span>
						<span class="btn-label">DNI / NIE</span>
						<span class="btn-sublabel">2 caras</span>
					</button>
					<button id="loadScanBtn" class="btn btn-main btn-other" title="Cargar Ãºltimo escaneo (1 imagen)">
						<span class="btn-icon-large">ğŸ“„</span>
						<span class="btn-label">Otro documento</span>
						<span class="btn-sublabel">1 cara</span>
					</button>
				</div>

				<!-- Botones de selecciÃ³n de archivos -->
				<div class="file-buttons">
					<button id="selectDniFilesBtn" class="btn btn-secondary btn-file">ğŸ“ Seleccionar 2 archivos (DNI/NIE)</button>
					<button id="selectFileBtn" class="btn btn-secondary btn-file">ğŸ“ Seleccionar archivo</button>
				</div>
				<input type="file" id="fileInput" accept="image/*" />
				<input type="file" id="fileInputMultiple" accept="image/*" multiple />

				<!-- Drop zone (para drag & drop) -->
				<div id="dropZone" class="drop-zone">
					<p>o arrastra una imagen aquÃ­</p>
				</div>

				<!-- Preview imagen Ãºnica -->
				<div id="preview" class="preview hidden">
					<img id="previewImage" alt="Preview" />
					<span id="previewLabel" class="preview-label hidden"></span>
					<button id="clearImage" class="btn-close" title="Eliminar">Ã—</button>
					<!-- Alerta de detecciÃ³n de rostro fallida -->
					<div id="faceDetectionError" class="face-detection-warning hidden">
						<p>No se detectÃ³ cara. Puedes continuar sin aÃ±adir la foto del huÃ©sped.</p>
					</div>
					<!-- Selector de caras detectadas -->
					<div id="faceSelector" class="face-selector hidden">
						<div class="face-selector-header">
							<p class="face-selector-title">Selecciona la foto del huÃ©sped:</p>
						</div>
						<div id="faceSelectorGrid" class="face-selector-grid"></div>
						<button id="noPhotoBtn" class="btn-no-photo">âŒ Continuar sin foto</button>
					</div>
				</div>

				<div id="previewDni" class="preview-dni hidden">
					<div class="dni-images">
						<div class="dni-image-container">
							<img id="previewImage1" alt="Cara 1" />
							<span class="dni-label">Cara 1</span>
						</div>
						<div class="dni-image-container">
							<img id="previewImage2" alt="Cara 2" />
							<span class="dni-label">Cara 2</span>
						</div>
					</div>
					<button id="clearDniImages" class="btn-close" title="Eliminar">Ã—</button>
					<!-- Selector de caras detectadas para DNI -->
					<div id="faceSelectorDni" class="face-selector hidden">
						<div class="face-selector-header">
							<p class="face-selector-title">Selecciona la foto del huÃ©sped:</p>
						</div>
						<div id="faceSelectorGridDni" class="face-selector-grid"></div>
						<button id="noPhotoBtnDni" class="btn-no-photo">âŒ Continuar sin foto</button>
					</div>
				</div>

				<!-- BotÃ³n escanear -->
				<button id="scanBtn" class="btn btn-action" disabled>
					<span id="scanText">Escanear y rellenar</span>
					<span id="scanLoader" class="loader hidden"></span>
				</button>

				<!-- Resultados -->
				<div id="results" class="results hidden">
					<details>
						<summary>Ver datos extraÃ­dos</summary>
						<div id="extractedData"></div>
					</details>
					<details>
						<summary>Uso de tokens</summary>
						<div id="tokenUsage" class="token-usage"></div>
					</details>
				</div>

				<!-- Mensajes de estado -->
				<div id="statusMessage" class="status-message hidden"></div>
			</div>
			<!-- Tab Content: Cruces -->
			<div id="tab-cruces" class="tab-content">
				<div class="cruces-section">
					<h3>Hoja de Cruces</h3>
					<p class="cruces-description">Genera un Excel mostrando entradas, ocupadas y salidas del dÃ­a.</p>

					<div class="cruces-date-selector">
						<label class="settings-label">Seleccionar fecha:</label>
						<input type="date" id="crucesDate" class="cruces-date-input" />
					</div>

					<button id="generateCrucesBtn" class="btn btn-action btn-full">Generar papel de cruces</button>

					<div id="crucesStatus" class="status-message hidden"></div>
				</div>
			</div>
			<!-- Vista de progreso (se muestra al escanear) -->
			<div id="progressView" class="progress-view hidden">
				<div class="progress-header">
					<h3>Procesando documento</h3>
				</div>

				<div class="progress-steps">
					<div id="step1" class="step">
						<div class="step-icon">â³</div>
						<div class="step-content">
							<div class="step-title">Verificando formulario</div>
							<div class="step-description">Comprobando modo ediciÃ³n...</div>
						</div>
					</div>

					<div id="step2" class="step pending">
						<div class="step-icon">â³</div>
						<div class="step-content">
							<div class="step-title">Analizando documento</div>
							<div class="step-description">Extrayendo datos...</div>
						</div>
					</div>

					<div id="step3" class="step pending">
						<div class="step-icon">â³</div>
						<div class="step-content">
							<div class="step-title">Rellenando formulario</div>
							<div class="step-description">Completando campos en Cloudbeds...</div>
						</div>
					</div>
				</div>

				<!-- Botones finales -->
				<div id="progressActions" class="progress-actions hidden">
					<button id="scanAnotherBtn" class="btn btn-action">Escanear otro documento</button>
				</div>
				<!-- Botones de error -->
				<div id="errorActions" class="progress-actions hidden">
					<button id="retryBtn" class="btn btn-action"><span>ğŸ”„</span> Reintentar</button>
					<button id="cancelBtn" class="btn btn-secondary btn-full">Cancelar</button>
				</div>
				<!-- Datos extraÃ­dos (colapsable) -->
				<div id="progressData" class="progress-data hidden">
					<details>
						<summary>ğŸ“‹ Ver datos extraÃ­dos</summary>
						<div id="progressExtractedData" class="extracted-data-grid"></div>
					</details>
					<details>
						<summary>ğŸ“Š Uso de tokens</summary>
						<div id="progressTokenUsage" class="token-usage"></div>
					</details>
				</div>
			</div>

			<!-- Tab Content: Ajustes -->
			<div id="tab-settings" class="tab-content">
				<div class="settings-section">
					<label class="settings-label">OpenAI API Key</label>
					<div class="input-group">
						<input type="password" id="apiKey" placeholder="sk-..." />
						<button id="toggleKey" class="btn-icon-small" title="Mostrar/Ocultar">ğŸ‘ï¸</button>
					</div>
					<button id="saveKey" class="btn btn-secondary btn-full">Guardar</button>
					<div id="keyStatus" class="status"></div>
				</div>

				<div class="settings-divider"></div>

				<div class="settings-section">
					<label class="settings-label">Carpeta del escÃ¡ner</label>
					<p class="settings-hint">Carpeta donde se guardan los escaneos</p>
					<div id="scanFolderPath" class="folder-path">No configurada</div>
					<button id="selectFolderBtn" class="btn btn-secondary btn-full">ğŸ“‚ Seleccionar carpeta</button>
					<div id="folderStatus" class="status"></div>
				</div>

				<div class="settings-divider"></div>

				<div class="settings-section">
					<label class="settings-label">Opciones adicionales</label>
					<label class="checkbox-label">
						<input type="checkbox" id="uploadPhotoCheckbox" />
						<span>Subir foto del huÃ©sped (extraÃ­da automÃ¡ticamente del documento)</span>
					</label>
				</div>

				<div class="settings-divider"></div>

				<div class="settings-credits">
					<p>Desarrollado por <a href="https://github.com/domindez" target="_blank" rel="noopener">Domindez</a></p>
					<p class="version">v1.2.0</p>
				</div>
			</div>
		</div>

		<script src="lib/face-api.min.js"></script>
		<script src="lib/exceljs.min.js"></script>
		<script src="face-detector.js"></script>
		<script src="cruces.js"></script>
		<script src="popup.js"></script>
	</body>
</html>
